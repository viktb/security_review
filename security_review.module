<?php

use Drupal\security_review\Check;
use Drupal\security_review\CheckResult;
use Drupal\security_review\Checks\AdminPermissions;
use Drupal\security_review\Checks\BaseUrl;
use Drupal\security_review\Checks\ErrorReporting;
use Drupal\security_review\Checks\ExecutablePhp;
use Drupal\security_review\Checks\FailedLogins;
use Drupal\security_review\Checks\Field;
use Drupal\security_review\Checks\FilePermissions;
use Drupal\security_review\Checks\InputFormats;
use Drupal\security_review\Checks\PrivateFiles;
use Drupal\security_review\Checks\QueryErrors;
use Drupal\security_review\Checks\TemporaryFiles;
use Drupal\security_review\Checks\UploadExtensions;
use Drupal\security_review\Checks\ViewsAccess;
use Drupal\security_review\SecurityReview;

/**
 * Implements hook_security_review_checks().
 */
function security_review_security_review_checks() {
  return array(
    new AdminPermissions(),
    new BaseUrl(),
    new ErrorReporting(),
    new ExecutablePhp(),
    new FailedLogins(),
    new Field(),
    new FilePermissions(),
    new InputFormats(),
    new PrivateFiles(),
    new QueryErrors(),
    new TemporaryFiles(),
    new UploadExtensions(),
    new ViewsAccess(),
  );
}

/**
 * Implements hook_security_review_log().
 */
function security_review_security_review_log(Check $check, $message, array $context, $level) {
  Drupal::logger('security_review')->log($level, $message, $context);
}

/**
 * Implements hook_modules_uninstalled().
 */
function security_review_modules_uninstalled($modules) {
  // Delete any orphaned check data.
  SecurityReview::cleanStorage();
}

/**
 * Implements hook_theme().
 */
function security_review_theme($existing, $type, $theme, $path) {
  return array(
    'check_evaluation' => array(
      'template' => 'check_evaluation',
      'variables' => array(
        'paragraphs' => array(),
        'items' => array()
      )
    ),
    'check_help' => array(
      'template' => 'check_help',
      'variables' => array(
        'title' => array(),
        'paragraphs' => array()
      )
    ),
    'general_help' => array(
      'template' => 'general_help',
      'variables' => array(
        'paragraphs' => array(),
        'checks' => array()
      )
    ),
    'run_and_review' => array(
      'template' => 'run_and_review',
      'variables' => array(
        'date' => array(),
        'checks' => array()
      )
    ),
  );
}

/**
 * Preprocesses variables for template 'run_and_review'.
 */
function template_preprocess_run_and_review(&$variables) {
  // Get icon list.
  global $base_url;
  $icons_root = $base_url . base_path() . 'core/misc/icons/';
  $variables['icons'] = array(
    'success' => $icons_root . '73b355/check.svg',
    'warning' => $icons_root . 'e29700/warning.svg',
    'fail' => $icons_root . 'ea2800/error.svg'
  );

  // Format date.
  $variables['date'] = format_date($variables['date']);

  // Convert check result integers to strings.
  foreach ($variables['checks'] as &$check) {
    switch ($check['result']) {
      case CheckResult::SUCCESS:
        $check['result'] = 'success';
        break;
      case CheckResult::FAIL:
        $check['result'] = 'fail';
        break;
      case CheckResult::WARN:
        $check['result'] = 'warning';
        break;
      case CheckResult::INFO:
        $check['result'] = 'info';
        break;
    }
  }
}

/**
 * Implements hook_cron().
 */
function security_review_cron() {
  // Store the web server's user.
  SecurityReview::setServerData();
}
